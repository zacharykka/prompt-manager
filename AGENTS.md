# AGENTS.md — 核心工作规范（优化版）

> **目的**：为 Codex CLI / Agents 提供统一、可执行、可审计的工作规则，涵盖 MCP 调用、任务流、失败/降级策略与合规性要求。  
> **适用对象**：所有会发起外呼、调用 MCP 服务或变更代码/文档的 Agent / 自动化流程 / 人类审阅者。

---

## 版本与变更说明
- **版本**：v1.1（优化版）  
- **主要改进**：
  - 结构化、模块化规则（更易检索与执行）。
  - 将失败/降级策略、可追溯性与审计模板标准化。
  - 为每个 MCP 服务补充“输入/输出/降级/示例”说明，便于实现与测试。
  - 增加快速检查清单与常见示例（便于运行时校验）。

---

## 0. MUST（强制遵守）

> 所有 Agent/流程在任何外呼或代码变更前必须遵守本节规则；违反将触发中止与强制修正。

- **前置说明（必填）**
  - 每次答复/PR/自动化输出**开头**必须包含 `前置说明`，至少包含：任务目标、已知输入、关键约束、是否允许外呼（是/否）。
  - 若有外呼（任何网络查询或第三方服务）→ 回应末尾**必须**附 `工具调用简报`（参见模板）。

- **退避与重试（必执行）**
  - 429 → 指数/固定退避：**退避 20s**，可重试（策略视具体场景）。  
  - 5xx 或 请求超时 → **退避 2s**，**最多重试 1 次**。  
  - 若仍失败 → 停止外呼，返回**保守离线答案**并显式标注不确定性与局限。  
  - 所有重试行为须在“工具调用简报”中记录（重试次数与时间）。

- **安全与合规**
  - 网络调用**只读**（不得在外呼中上传用户/凭证/敏感数据）。  
  - 遵守目标站点 robots.txt、ToS 与隐私政策。  
  - 优先选择官方/权威来源（如官方文档、权威机构、可靠库主页）。

- **语言与编码**
  - 以 **中文为首选沟通语言**（除非用户另有要求）。  
  - 文件编码 **UTF-8（无 BOM）**。文本须避免非标准字符。

- **开发约束**
  - **编码前必须执行 `Sequential-Thinking` 分析**（产出简洁可执行计划，≤10 步）。  
  - 仅修改必要行/必要文件；遵循“小步提交/小 PR”的原则。  
  - 明确禁止危险命令（例如 `rm -rf` 等不可逆命令）及在提交中泄露密钥/令牌/内部链接。  
  - 所有涉及任务编排/待办/里程碑的场景必须使用 `shrimp-task-manager`（并在 `.shrimp` 目录下持久化任务）。

- **变更策略**
  - 正确性优先于兼容性；在必要时允许破坏性改动，但 PR **必须**提供迁移方案或写明“无迁移，直接替换”。  
  - 删除冗余、过时内容是允许且被鼓励的。

- **MCP 使用约束**
  - 所有需要外呼的查询/文档检索必须通过 MCP 服务执行

---

## 1. MCP 工具选择（概览）

**原则**：按需选择最贴合任务意图的单一服务；如需多服务，必须串行调用并在“工具调用简报”中说明理由与顺序。

- **SequentialThinking**
  - 用途：复杂任务拆解、规划、里程碑产出（只输出可执行计划）。
  - 输入：问题/目标/约束（简述）。期望输出：步骤列表（6–10 步，每步一句话）。
  - 输出限制：仅计划与里程碑，不暴露中间链路式推理。
  - 降级：若不可用 → 本地保守计划（标注不确定性）。

- **Context7**
  - 用途：检索/解析官方文档、API 说明、版本差异。
  - 常用流程：`resolve-library-id` → `get-library-docs`（tokens ≤5000，topic 精简）。
  - 输出：精炼答案 + 出处（库 ID / 版本 / 段落引用）。避免大段复制。
  - 降级：Context7 失败 → 退而求 DuckDuckGo（优先官方站点）→ 若仍失败则给保守离线答案并标注不确定性。

- **DuckDuckGo**
  - 用途：获取最新网页、公告、官方链接（非结构化网络搜索）。
  - 查询建议：12 个精准关键词 + 限定词（例如 `site:example.com`、`filetype:pdf`、`after:YYYY-MM-DD`）。  
  - 参数：safesearch=moderate，maxResults ≤ 35，timeout ≤ 5s。结果去重、排除内容农场/再分发站点。  
  - 输出：标题 + 简述 + URL + 发布时间（若可得）。

- **Serena（可选）**
  - 用途：跨文档检索与聚合总结（当需要多文档汇总时使用）。
  - 推荐参数：`top_k=5`、`max_tokens=700`、`citations=true`。
  - 降级：不可用时可用 SequentialThinking（产出最小可行计划）或 DuckDuckGo（抓取原始页面）。

- **shrimp-task-manager**
  - 用途：任务落地、里程碑/待办/状态管理。  
  - 存储：本地 `.shrimp` 目录（模板支持中文）。
  - 使用场景：任何需要持续追踪的任务（长期任务、跨团队交付等）。

- **降级通用原则**
  - Context7 → DuckDuckGo → 离线保守答案（带不确定性标注）  
  - SequentialThinking/Serena → 返回最小可行计划（或保守备选方案）

---

## 2. 工作流（R → P → I → V → D）

**目标**：把每个变更分解为可验证的小步骤，确保可审计与可回退。

1. **Research（调研）**
   - 使用 `rg -n` 等本地检索工具进行分块阅读与约束识别。  
   - 记录未知项与假设（写在 `前置说明` 中）。

2. **Plan（规划）**
   - 使用 `SequentialThinking` 产出可执行步骤（≤10）。  
   - 定义每步的验收标准（何为通过、何为失败）。

3. **Implement（实现）**
   - 小步提交（`apply_patch`），中文注释/PR 描述。  
   - 仅修改必要文件/行，并在 PR 中说明改动范围。

4. **Verify（验证）**
   - 自动化测试（单元/集成/回归）、构建通过、边界条件与性能风险检查、静态扫描（安全/依赖）。  
   - 若有外呼结果依赖，校验来源可信度与可重复性。

5. **Deliver（交付）**
   - 总结变更、风险、验证结果。  
   - 推送代码至github/gitea/gitlab等
   - 若有外呼 → 在交付文档或答复末尾附 `工具调用简报`（详见模板）。

---

## 3. MCP 调用规则（详）

### 全局策略
- **单轮单工具**：单次对话/交互（单轮）中**优先只调用 1 种服务**。确需多种服务时，应串行调用并在“工具调用简报”中说明原因与顺序。  
- **最小必要原则**：收敛查询范围（限制 tokens、结果数、时间窗、关键词），避免无谓海量检索。  
- **可追溯性**：所有外呼必须可追溯 —— 在答复末尾附 `工具调用简报`（工具、输入摘要、参数、时间、主要来源/重试记录）。  
- **失败/降级**：按退避策略重试；若仍失败，按照降级路径返回离线保守答案，并在答复中标注“已降级、原因、风险与不确定性”。

### 服务级别说明（选取要点）
- 每个服务的输入/输出/参数/降级策略都应在本地 mock 与测试用例中覆盖。
- 输出结果须带时间戳与检索参数快照，便于审计。

---

## 4. 工具调用简报（模板 & 示例）

### 模板（必填）
```text
工具: <SequentialThinking|Context7|DuckDuckGo|Serena|shrimp-task-manager>
触发原因: <为何需要该工具>
输入摘要: <关键词 / 库 / topic / 查询意图>
参数: <关键参数，例如 tokens/结果数/时间窗/timeout>
结果概览: <条数 / 主要来源域名 / 是否命中 / 主要结论>
重试/退避: <是否重试 / 重试次数 / 退避策略>
时间(UTC): <YYYY-MM-DDTHH:MM:SSZ>
备注: <不确定性 / 下步建议>
```

### 示例
```text
工具: DuckDuckGo
触发原因: 验证 libfoo 2.3.1 的发布说明
输入摘要: "libfoo 2.3.1 release notes site:libfoo.org after:2025-06-01"
参数: maxResults=20, timeout=5s, safesearch=moderate
结果概览: 3 条命中（libfoo.org、github release、第三方博客）；优先采用 libfoo.org 的发布页
重试/退避: 无重试（首次成功）
时间(UTC): 2025-09-15T07:12:02Z
备注: 第三方博客与官方时间不一致，优先官方；若需补充 patch diff，请调用 Context7
```

## 5. 违规处理与纠正流程
若发现缺少 前置说明/工具调用简报/退避/UTF-8/中文输出 等强制项 → 立即中止外呼，回退到 Research/Plan 并补齐缺失项后重试。
- 回复/PR 中必须标注修正动作与理由，并提供保守离线答案与局限说明。
- 若多次违规 → 在 PR 中强制加入“回退策略/开关”，并考虑拆分任务降低风险。
- 违规样例处理（快速流程）：
	1. 停止当前外呼/部署。
	2. 在 issue/PR 中记录违规点与修正计划。
	3. 执行修正并通过 Verify 步骤后再交付。

## 附录：快速检查清单（Deploy 前）

- 答复/PR 开头包含 前置说明（目标/输入/约束/是否外呼）
- 若外呼，末尾包含 工具调用简报（按模板）
- 已执行 SequentialThinking 分解（若涉及实现）
- 只修改必要文件/行，已有变更说明与迁移计划（或写明“无迁移”）
- 已运行自动化测试并记录主要结果（构建/单测/安全扫描）
- 无敏感信息泄露（密钥/令牌/内部链接）
- 使用 shrimp-task-manager 记录任务（如适用）

## 词汇表（简短）
- 外呼：任何向外部网络或第三方服务发起的请求（包含搜索引擎、API、库检索等）。
- 保守离线答案：基于内部知识与稳健假设的答案，带显式不确定性标注。
- 工具调用简报：记录外呼行为与结果的结构化摘要，便于审计与溯源。
- 退避：遇到限流/错误时的等待策略。

⸻

## 最后说明
- 本文档为 强制执行 的规范；所有 Agent、自动化脚本及参与交付的工程师都必须遵守。
- 若需调整、补充工具或参数（例如新增 MCP 服务），请提交 PR 并在 PR 描述中包含兼容性/迁移说明与测试计划。

